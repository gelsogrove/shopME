# Authentication Cookie Discrepancy Fix

## Issue Description

We encountered an authentication issue where users were being logged out unexpectedly or failing to authenticate properly. After investigation, we identified two main issues:

1. **Cookie Name Discrepancy**: The auth controller was setting cookies with the name `auth_token`, but the auth middleware was looking for cookies named `token`.

2. **JWT Payload Structure Mismatch**: The JwtPayload interface in the auth middleware didn't match the actual token structure being generated by the auth controller.

## Root Causes

1. The authentication controller was setting cookies with one name while the middleware was expecting another name.
2. The authentication middleware was expecting a token payload with different field names than what was being generated.
3. There was inconsistency in JWT secret access, with some code using environment variables directly and others using the config object.

## Solution

### 1. Cookie Name Alignment

We updated the auth middleware to look for cookies with the name `auth_token` to match what's being set by the auth controller:

```typescript
// Before
const cookieToken = req.cookies.token;

// After
const cookieToken = req.cookies.auth_token;
```

### 2. JWT Payload Interface Update

We updated the JwtPayload interface in the middleware to match the structure being generated:

```typescript
// Before
interface JwtPayload {
  userId: string
  email: string
  workspaces: Array<{
    id: string
    role: string
  }>
}

// After
interface JwtPayload {
  id: string
  email: string
  role: string
}
```

### 3. Consistent JWT Secret Usage

We updated all code to use the secret from the config object instead of environment variables directly:

```typescript
// Before
jwt.verify(token, process.env.JWT_SECRET || "your-secret-key")

// After
jwt.verify(token, config.jwt.secret)
```

### 4. Frontend Logout Implementation

We implemented a proper logout function in the frontend that:
- Calls the backend logout endpoint to clear the HTTP-only cookie
- Clears user data from localStorage
- Redirects to the login page

## Benefits

1. **Improved Security**: Authentication tokens are now properly stored as HTTP-only cookies
2. **Consistent Authentication**: Users stay logged in properly across page reloads
3. **Better Error Handling**: Added error logging for authentication issues
4. **Proper Logout Flow**: Users can now properly log out with all tokens being invalidated

## Future Improvements

1. Implement stronger CSRF protection for cookie-based authentication
2. Add refresh token mechanism for longer sessions
3. Implement proper session audit logging
4. Enhance the authentication middleware to better handle different token formats 