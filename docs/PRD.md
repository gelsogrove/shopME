# ShopMe Project -3. **Pulizia URL**

- Rimozione URL scaduti/vecchi
- Pulizia oraria
- Mantenimento database ottimizzato

**Dettagli Tecnici**: Vedere `docs/memory-bank/scheduler-service.md`ct Requirements Document (PRD)

## Scheduler Service (October 2025) üÜï

Lo Scheduler Service √® un sistema di manutenzione automatica che gestisce:

1. **Pulizia Chat**

   - Mantiene solo gli ultimi 50 messaggi per sessione
   - Pulizia automatica ogni 12 ore
   - Ottimizzazione performance database

2. **Gestione Offerte**

   - Disattivazione automatica offerte scadute
   - Controllo ogni 5 minuti
   - Solo offerte valide visibili ai clienti

3. **Pulizia URL**
   - Rimozione URL scaduti/vecchi
   - Pulizia oraria
   - Mantenimento database ottimizzato

Per dettagli completi vedere: `docs/memory-bank/scheduler-service.md`

## Public Orders (Phone-based External Links)

[Testing details removed]

### üöÄ **Performance Optimizations**

- **Code Cleanup**: Rimossi duplicati, imports inutilizzati, e codice morto
- **TypeScript Strict**: Nessun warning di compilazione
- **Optimized Builds**: Frontend (1,296 kB) e Backend compilati senza errori
- **Debounced Search**: Ricerca prodotti ottimizzata con 300ms delay
- **Smart State Management**: Gestione stato React ottimizzata

### üìã **User Experience Flow**

1. **Step 1 - Products**: Lista prodotti con pulsante "Aggiungi Prodotto" e gestione quantit√†
2. **Step 2 - Addresses**: Indirizzi pre-compilati con dati cliente (nome, telefono, azienda), validazione completa dei campi obbligatori prima del passaggio allo step 3
3. **Step 3 - Confirmation**: Riepilogo ordine e conferma finale con validazione finale prima del submit
4. **Multi-Language**: Interface automaticamente nella lingua del cliente
5. **Error Handling**: Gestione errori user-friendly con messaggi localizzati e toast notifications specifiche
6. **Auto-Save**: Aggiornamento automatico database cliente con indirizzi inseriti nel checkout

### üîó **API Endpoints**

### üì± **Integration Points**

- **WhatsApp Chatbot**: Genera link checkout via `confirmOrderFromConversation()`
- **N8N Workflow**: Integrazione automatica con link generation
- **Order Management**: Connessione diretta con sistema gestione ordini
- **Customer Profile**: Integrazione con dati cliente per pre-popolazione

### üéØ **Business Impact**

- **Reduced Cart Abandonment**: UI ottimizzata e flusso semplificato
- **Multi-Market Ready**: Supporto 4 lingue per espansione internazionale
- **Mobile Optimized**: Responsive design per WhatsApp mobile users
- **Conversion Optimization**: Add products durante checkout per upselling
- **üÜï Improved Customer Experience**: Auto-update indirizzi riduce friction nel checkout
- **üÜï Data Quality**: Indirizzi sempre aggiornati e consistenti nel database

### üèÜ **Implementation Summary**

Il sistema checkout √® ora **completamente funzionale e production-ready**. Tutte le richieste originali sono state implementate:

‚úÖ **Token validation fix**: Risolto "Link Error" con validazione centralizzata  
‚úÖ **Multi-language support**: Checkout si adatta automaticamente alla lingua del cliente (IT/EN/ES/PT)  
‚úÖ **Add products functionality**: Modal completo per ricerca e aggiunta prodotti durante checkout  
‚úÖ **Address pre-population**: Indirizzi caricati automaticamente dai dati cliente incluso supporto per azienda  
‚úÖ **üÜï Enhanced Step 2**: Validazione completa step 2 con controllo campi obbligatori e toast notifications  
‚úÖ **üÜï Address auto-update**: Sistema automatico di salvataggio indirizzi e azienda durante checkout  
‚úÖ **üÜï Cart reset**: Svuotamento automatico carrello al completamento ordine  
‚úÖ **UI consistency**: Schema colori standardizzato blu/verde in tutto il sistema  
‚úÖ **Code optimization**: Codice pulito, TypeScript strict, build ottimizzati

**Next Steps**: Focus su language detection bug fix e completamento integration test suite.

### ‚è≥ Phase 2 Tasks (Deferred)

- **Advanced WhatsApp Features** (media, templates, bulk, scheduling)
- **Security & Performance Optimization** (rate limiting, 2FA, monitoring, OWASP)
- **Full Application Responsiveness** (mobile/tablet/desktop)
- **Database Cleanup** (remove unused tables)

---

## üìã Task List Reference

- Minimal Phase 1 checklist: `docs/task-list.md`
- Full, up-to-date structured list (completed, active, bugs, Phase 2): `docs/other/task-list.md`

---

## ‚ùì **FREQUENTLY ASKED QUESTIONS - TECHNICAL CLARIFICATIONS**

### **Q1: Come si calcolano i prezzi con sconti e offerte?**

**A:** [DA CHIARIRE CON ANDREA]

- Vince lo sconto pi√π alto o sono cumulativi?
- Quale ordine di priorit√†: sconto prodotto > sconto categoria > sconto workspace?
- Come gestire percentuali vs importi fissi?

### **Q2: Gestione Canale Disattivo - Messaggio WIP**

**A:** [DA CHIARIRE CON ANDREA]

- Dove si trova il messaggio "Work in Progress" multilingua?
- √à nel database (tabella `gdprContent` o simile)?
- √à hardcoded per lingua o configurabile per workspace?

### **Q3: LLM di Formattazione in N8N**

**A:** ‚úÖ **IMPLEMENTATO - SINGLE LLM ARCHITECTURE**

- **LLM Agent (OpenRouter)**: Gestisce RAG search e genera risposta conversazionale
- Configurazione dinamica dalla tabella `agentConfig` (prompt, temperatura, token, modello)
- Integrato con N8N Agent Node per gestione completa del workflow

### **Q4: Calling Functions con Token di Protezione**

**A:** ‚úÖ **IMPLEMENTATO**

- Token interno N8N: `internal_api_secret_n8n_shopme_2024`
- SecureTokenService per customer tokens temporanei
- Cleanup automatico after expiration (1 ora)

### **Q5: Usage Tracking System**

**A:** ‚úÖ **IMPLEMENTATO COMPLETAMENTE**

- **LLM Response**: ‚Ç¨0.15 (15 centesimi) per ogni risposta chatbot
- **New Customer**: ‚Ç¨1.50 (1.50 euro) per ogni nuovo cliente registrato
- **New Order**: ‚Ç¨1.50 (1.50 euro) per ordine completo
- **Push Message**: ‚Ç¨0.50 (50 centesimi) per notifiche push standalone
- **Tracciamento automatico**: Integrato in tutti i controller con single point of truth
- **Dashboard analytics**: Statistiche complete con grafici e export
- **Filtri di sicurezza**: Solo clienti registrati con `activeChatbot: true`

### **Q6: N8N Auto-Setup e Import Automatico**

**A:** ‚úÖ **IMPLEMENTATO COMPLETAMENTE**

- **Flusso attivo**: S√å - workflow creato automaticamente e impostato `active: true`
- **Workflow completo**: S√å - Single LLM Agent con RAG integration
- **Credenziali**: S√å - Basic Auth automaticamente configurato per Internal API
- **Owner account**: S√å - `admin@shopme.com / Venezia44`
- **Script**: `scripts/n8n_import-optimized-workflow.sh` - setup completamente automatico
- **Files**: `n8n/shopme-whatsapp-workflow.json` + credentials
- **Processo**: Docker start ‚Üí Owner setup ‚Üí Credential import ‚Üí Workflow import ‚Üí Activation

### **üîë N8N CREDENTIALS CONFIGURATION**

**CREDENZIALI OBBLIGATORIE PER FUNZIONAMENTO N8N:**

#### **1. N8N Admin Login**

- **Email**: `admin@shopme.com`
- **Password**: `Venezia44` (uppercase V required)
- **URL**: http://localhost:5678
- **Setup**: Automatico via `scripts/n8n_import-optimized-workflow.sh`

#### **2. Backend API Authentication (Basic Auth)**

- **Name**: `Backend API Basic Auth`
- **Type**: `Basic Authentication`
- **Username**: `admin`
- **Password**: `admin`
- **Usage**: Per chiamate HTTP al backend `/api/internal/*`
- **Nodes**: LLM Router, RAG Search, Save Message, Generate Token

#### **3. OpenRouter API Authentication (Header Auth)**

- **Name**: `OpenRouter API`
- **Type**: `Header Auth`
- **Header Name**: `Authorization`
- **Header Value**: `Bearer ${OPENROUTER_API_KEY}`
- **Usage**: Per chiamate LLM dirette a OpenRouter
- **Nodes**: LLM Router, LLM Formatter

#### **4. WhatsApp Business API (Header Auth)**

- **Name**: `WhatsApp Business API`
- **Type**: `Header Auth`
- **Header Name**: `Authorization`
- **Header Value**: `Bearer ${WHATSAPP_TOKEN}`
- **Usage**: Per invio messaggi WhatsApp
- **Nodes**: Send WhatsApp Message

#### **üìã SETUP AUTOMATICO CREDENZIALI:**

#### **‚ö†Ô∏è CONFIGURAZIONE MANUALE (se automatico fallisce):**

1. Login N8N: http://localhost:5678 (`admin@shopme.com / Venezia44`)
2. Settings ‚Üí Credentials ‚Üí Create New
3. Seleziona tipo appropriato (Basic Auth, Header Auth)
4. Inserisci nome e valori come specificato sopra
5. Salva e assegna ai nodi workflow appropriati

### **Q7: Logica RAG Condizionale**

**A:** ‚úÖ **IMPLEMENTATO**

- LLM Router classifica l'intenzione: sociale vs prodotto/servizio
- Pattern sociali (saluti, ringraziamenti) = NO RAG
- Pattern commerciali (prodotti, prezzi, ordini) = S√å RAG
- Endpoint: `/internal/llm-router`

### **Q8: Disable Chatbot - Non Rispondere**

**A:** ‚úÖ **IMPLEMENTATO**

- Check `workspace.isActive` e `whatsappSettings.isActive`
- Se disattivo, nessuna risposta automatica
- Implementato nel workflow N8N e backend

### **Q9: Invoice Management System**

**A:** ‚úÖ **TASK DOCUMENTATO - DA IMPLEMENTARE**

- **CF Function**: `ReceiveInvoice` con filtro codice ordine
- **Pagina lista fatture**: Design coerente con registrazione + token security
- **Download PDF**: Sistema di token temporanei per sicurezza
- **Database schema**: Tabella `invoices` con relazioni customer/workspace

---

## üí∞ **USAGE TRACKING SYSTEM - COMPLETE IMPLEMENTATION**

### **üéØ Overview**

Il sistema di billing traccia automaticamente tutti i costi secondo la pricing list ufficiale. Tutti i costi vengono registrati nel database con dettagli progressivi (previous/current/new total), permettendo di visualizzare una cronologia completa delle transazioni.

**Pricing List Ufficiale (Ottobre 2025):**

| Servizio            | Costo  | Descrizione                                         |
| ------------------- | ------ | --------------------------------------------------- |
| **MONTHLY_CHANNEL** | ‚Ç¨19.00 | Costo fisso mensile per workspace                   |
| **MESSAGE**         | ‚Ç¨0.15  | Costo per messaggio/interazione                     |
| **NEW_CUSTOMER**    | ‚Ç¨1.50  | Costo per nuovo cliente (alla registrazione)        |
| **NEW_ORDER**       | ‚Ç¨1.50  | Costo per nuovo ordine                              |
| **HUMAN_SUPPORT**   | ‚Ç¨1.00  | Costo per riattivazione chatbot dopo supporto umano |
| **PUSH_MESSAGE**    | ‚Ç¨1.00  | Costo per notifica push (cambio sconto)             |
| **NEW_FAQ**         | ‚Ç¨0.50  | Costo per creazione nuova FAQ                       |
| **ACTIVE_OFFER**    | ‚Ç¨0.50  | Costo per attivazione offerta                       |

### **‚úÖ Architettura Implementata**

#### **üîÑ BillingService - Single Point of Truth**

Il servizio `BillingService` centralizza tutti gli addebiti con metodi dedicati:

- `chargeMonthlyChannelCost(workspaceId)` - Costo mensile (‚Ç¨19.00)
- `trackMessage(workspaceId, customerId, description, userQuery)` - Messaggio (‚Ç¨0.15)
- `trackNewCustomer(workspaceId, customerId)` - Nuovo cliente (‚Ç¨1.50)
- `trackNewOrder(workspaceId, customerId, description)` - Nuovo ordine (‚Ç¨1.50)
- `trackHumanSupport(workspaceId, customerId, description)` - Supporto umano (‚Ç¨1.00)
- `trackPushMessage(workspaceId, customerId, description)` - Push notification (‚Ç¨1.00)
- `trackNewFAQ(workspaceId, customerId, description)` - Nuova FAQ (‚Ç¨0.50)
- `trackActiveOffer(workspaceId, offerId, offerTitle)` - Offerta attiva (‚Ç¨0.50)

Ogni metodo calcola automaticamente i totali progressivi (previousTotal + currentCharge = newTotal).

#### **üìä Database Schema**

#### **üéØ Trigger di Billing Automatici**

| Quando                | Cosa viene addebitato    | Dove                         |
| --------------------- | ------------------------ | ---------------------------- |
| Utente si registra    | NEW_CUSTOMER (‚Ç¨1.50)     | `registration.controller.ts` |
| Messaggio chatbot     | MESSAGE (‚Ç¨0.15)          | `message.repository.ts`      |
| Ordine confermato     | NEW_ORDER (‚Ç¨1.50)        | `order.service.ts`           |
| Riattivazione chatbot | HUMAN_SUPPORT (‚Ç¨1.00)    | `customers.controller.ts`    |
| Cambio sconto         | PUSH_MESSAGE (‚Ç¨1.00)     | `customers.controller.ts`    |
| Creazione FAQ         | NEW_FAQ (‚Ç¨0.50)          | `faq.controller.ts`          |
| Attivazione offerta   | ACTIVE_OFFER (‚Ç¨0.50)     | `offer.controller.ts`        |
| Inizio mese           | MONTHLY_CHANNEL (‚Ç¨19.00) | `scheduler.service.ts`       |

#### **üîÑ Flusso Esempio - Messaggio**

### **üìà Dashboard Analytics (System Logs)**

#### **API Endpoints**

#### **Visualizzazione Frontend**

- **System Logs Tab**: Tabella completa di tutte le transazioni billing
- **Filtro per Cliente**: Dropdown per filtrare per singolo cliente
- **Colonne**: Data/Ora, Tipo, Cliente, Dettagli, Costo, Formula (previous + current = new)
- **Grand Total**: Somma totale con conteggio operazioni
- **Progressive Totals**: Ogni riga mostra il calcolo progressivo

#### **Metriche Business Intelligence**

- **Total Revenue**: Somma di tutti i costi nel periodo
- **Per Customer**: Breakdown dei costi per cliente
- **Per Type**: Distribuzione dei costi per tipo di operazione
- **Trends**: Grafici di andamento giornaliero/mensile
- **Top Spenders**: Clienti che generano pi√π costi

- Clienti pi√π attivi per targeting marketing
- Ore di punta per ottimizzare staff
- Trend di crescita per budget planning
- Costi AI monitorati in tempo reale

### **üõ°Ô∏è Validazioni Automatiche**

- ‚úÖ **Solo clienti registrati**: `activeChatbot: true`
- ‚úÖ **Solo con risposta LLM**: `response && response.trim()`
- ‚úÖ **Workspace isolation**: `workspaceId` validation
- ‚úÖ **Error handling**: Non blocca il flusso principale

### **üõ†Ô∏è Debug Mode Configuration**

**IMPLEMENTATO**: Campo `debugMode` per disabilitare usage tracking durante testing/debug.

#### **üîß Technical Implementation**

#### **üé® Settings Interface**

- **Location**: `/settings` page in workspace settings section
- **Control**: Toggle/checkbox for "Debug Mode"
- **Description**: "When enabled, usage costs (‚Ç¨0.005) are not tracked. Use for testing purposes."
- **Default**: Always `true` (enabled by default)
- **Scope**: Per workspace (isolated configuration)

#### **üéØ Use Cases**

- **Development**: Avoid accumulating costs during feature development
- **Testing**: Skip tracking during automated testing and QA
- **Demo**: Clean cost tracking for client demonstrations
- **Debug**: Isolate functionality issues without cost implications

#### **üõ°Ô∏è Business Rules**

- **Default Behavior**: `debugMode: true` (no tracking) for all new workspaces
- **Production Safe**: Safe to use in production for testing scenarios
- **Workspace Isolated**: Each workspace controls its own debug mode
- **Audit Trail**: Debug mode status logged for transparency

### **üéØ Vantaggi Architettura Andrea**

1. **Performance**: Zero overhead di chiamate HTTP extra
2. **Reliability**: Single point of failure = maggiore stabilit√†
3. **Security**: Nessun endpoint pubblico esposto
4. **Maintainability**: Un solo posto da mantenere
5. **Debug Flexibility**: Usage tracking can be disabled per workspace for testing

---

## üõí **ORDERS & CART MANAGEMENT SYSTEM - ENTERPRISE REDESIGN**

### **üéØ Overview**

Sistema completo di gestione ordini e carrello enterprise-grade che sostituisce l'attuale implementazione "oscena" con un'interfaccia consistente, funzionalit√† CRUD complete e business logic robusta.

### **üîó Accesso Ordini via Link Sicuro (TTL 1h)**

- **Intento generico (lista ordini / fattura / DDT senza numero ordine)**

  - Risposta: link a pagina lista ordini del cliente in ordine di data decrescente, con stato e totale
  - URL esempio: `https://app.example.com/orders?token=...`
  - Validit√†: token firmato (JWT HS256), TTL 1 ora; scaduto ‚Üí pagina non accessibile
  - Dal dettaglio ordine sono disponibili: download Fattura (PDF) e DDT (PDF)

- **Intento specifico (con numero ordine)**

  - Risposta: link diretto al dettaglio dell'ordine
  - URL esempio: `https://app.example.com/orders/ORD-123?token=...`

- **Token JWT (sicurezza)**

  - Claim minimi: `clientId`, `workspaceId`, `scope`
    - Lista: `orders:list`
    - Dettaglio: `orders:detail` + `orderCode`
  - Opzionali: `jti` (revoca/one-time), binding soft (user-agent/IP)
  - Niente dati sensibili nel payload

- **Frontend**

  - `OrdersListPage`: lista in ordine data decrescente, stato, totale; click ‚Üí dettaglio
  - `OrderDetailPage`: dettaglio ordine con pulsanti download Fattura e DDT

- **Backend (tutti validano token e workspace)**
  - `GET /api/orders` ‚Üí lista ordini per `clientId`
  - `GET /api/orders/:orderCode` ‚Üí dettaglio ordine
  - `GET /api/orders/:orderCode/invoice` ‚Üí download fattura
  - `GET /api/orders/:orderCode/ddt` ‚Üí download DDT

### **‚ùå Problemi Attuali**

- **Grafica inconsistente**: Layout e colori diversi dal resto dell'app
- **Zero CRUD**: Impossibile modificare ordini esistenti
- **Logica inesistente**: Nessuna gestione stati, stock, pagamenti
- **Carrello primitivo**: Non si pu√≤ modificare quantit√† o salvare carrello
- **Relazioni rotte**: Products ‚Üî OrderItems ‚Üî Orders non funzionano

### **‚úÖ Obiettivo Target**

**Sistema Orders & Cart di livello enterprise** con:

- üé® **Design System Consistency**: Stesso tema/colori di Products/Categories/Customers
- üõ†Ô∏è **CRUD Completo**: Create, Read, Update, Delete per tutti gli ordini
- üõí **Smart Cart**: Modifica qty, aggiungi/rimuovi prodotti, salvataggio persistente
- üìä **Business Intelligence**: Dashboard con analytics, filtri, ricerca avanzata
- üîÑ **Stock Management**: Gestione inventario automatica con validazioni

### **üèóÔ∏è Architettura & Design**

#### **üé® Design System Compliance**

#### **üì± Component Architecture**

### **üõí Smart Cart System - WhatsApp Chat Integration**

#### **System Overview**

The Smart Cart System provides **real-time cart management** directly within WhatsApp conversations using **AI-powered intent detection** and **secure token-based checkout**. The system combines SearchRAG cart-awareness with traditional calling functions for a seamless shopping experience.

#### **Architecture Components**

````mermaid
graph LR
    A[üë§ Cliente WhatsApp] --> B[ü§ñ DualLLMService]
    B --> C[üîç SearchRAG Cart-Aware]
    B --> D[‚ö° Calling Functions]
    C --> E[üîß FunctionHandlerService]
    D --> E
    E --> F[üõí CartService]
    F --> G[üîê SecureTokenService]
    G --> H[üåê CartPage Frontend]
üõí CHECKOUT ‚Üí üìã PENDING ORDER (Stock disponibile per altri)
         ‚Üì
üìû CONFERMA OPERATORE ‚Üí ‚úÖ CONFIRMED ORDER (Stock scalato)
         ‚Üì
üì¶ SHIPPED ‚Üí üéâ DELIVERED (Stock permanentemente venduto)
         ‚Üì
‚ùå CANCELLED/REFUNDED ‚Üí üîÑ STOCK RIPRISTINATO
üì± WhatsApp ‚Üí ü§ñ N8N ‚Üí üîê Backend ‚Üí üé® Frontend ‚Üí üìã Invoice Data
https://domain.com/invoice?token=abc123...&workspaceId=ws_456
1. CF ReceiveInvoice (senza orderCode) chiamata
   ‚Üì
2. Backend genera JWT token con customerId + workspaceId
   ‚Üì
3. Backend restituisce URL: "domain.com/customer/invoices?token=JWT_TOKEN"
   ‚Üì
4. Cliente clicca link WhatsApp
   ‚Üì
5. Frontend estrae token da URL query parameter
   ‚Üì
6. Frontend valida token (pre-check JWT decode)
   ‚Üì
7. Se valido: API call con token per recuperare fatture
   ‚Üì
8. Backend valida token + restituisce fatture del cliente
   ‚Üì
9. Frontend mostra lista fatture (ORDER BY id DESC)
üì± MESSAGGIO WHATSAPP
         |
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ üö® SPAM CHECK   ‚îÇ ‚îÄ‚îÄYES‚îÄ> üö´ AUTO-BLACKLIST + STOP
    ‚îÇ 10+ msg/30sec?  ‚îÇ         (customer + workspace)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |NO
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ CANALE ATTIVO?  ‚îÇ ‚îÄ‚îÄNO‚îÄ‚îÄ> ‚ùå STOP DIALOGO
    ‚îÇ (isActive)      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |YES
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ CHATBOT ATTIVO? ‚îÇ ‚îÄ‚îÄNO‚îÄ‚îÄ> üë®‚Äçüíº CONTROLLO OPERATORE
    ‚îÇ (activeChatbot) ‚îÇ         (salva msg, no AI response)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |YES
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ USER BLACKLIST? ‚îÇ ‚îÄ‚îÄYES‚îÄ> ‚ùå BLOCCA CONVERSAZIONE
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |NO
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ CANALE IN WIP?  ‚îÇ ‚îÄ‚îÄYES‚îÄ> ‚ö†Ô∏è MESSAGGIO WIP
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |NO
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ NUOVO UTENTE?   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |              |
       YES|              |NO
         v              v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ SALUTO?     ‚îÇ  ‚îÇ E' REGISTRATO?  ‚îÇ
    ‚îÇ Ciao/Hello  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         |        |
         |YES              NO|        |YES
         v                   v        v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ üéâ WELCOME  ‚îÇ  ‚îÇ üéâ WELCOME  ‚îÇ ‚îÇ >2 ORE ULTIMA   ‚îÇ ‚îÄ‚îÄYES‚îÄ> üëã BENTORNATO {NOME}
    ‚îÇ + REG LINK  ‚îÇ  ‚îÇ + REG LINK  ‚îÇ ‚îÇ CONVERSAZIONE?  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |                 |              |NO
         v                 v              v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ üîó TOKEN +  ‚îÇ  ‚îÇ ‚è≥ ATTENDI  ‚îÇ ‚îÇ ü§ñ RAG SEARCH + ‚îÇ
    ‚îÇ REGISTRA    ‚îÇ  ‚îÇ REGISTRA    ‚îÇ ‚îÇ ü§ñ LLM PROCESSING ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |                              |
         v                              v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ ü§ñ RAG +    ‚îÇ                ‚îÇ üí¨ RISPOSTA     ‚îÇ
‚îÇ LLM AGENT   ‚îÇ                ‚îÇ DISCORSIVA      ‚îÇ
‚îÇ PROCESSING  ‚îÇ                ‚îÇ + üí∞ USAGE      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         |
         v
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ üí¨ RISPOSTA ‚îÇ
    ‚îÇ DISCORSIVA  ‚îÇ
    ‚îÇ + üí∞ USAGE  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
+-------------------------+-------------------------+-------------------------+-------------------------+-------------------------+
| 1. PROBLEM              | 2. SOLUTION             | 3. UNIQUE VALUE         | 4. UNFAIR ADVANTAGE     | 5. CUSTOMER SEGMENTS    |
|                         |                         |    PROPOSITION          |                         |                         |
+-------------------------+-------------------------+-------------------------+-------------------------+-------------------------+
| ‚Ä¢ E-commerce and        | ‚Ä¢ WhatsApp-based        | ‚Ä¢ Unified commerce and  | ‚Ä¢ 98% message open      | ‚Ä¢ Small businesses      |
|   customer service      |   chatbot platform      |   customer care in      |   rate vs 20% email     |   without technical     |
|   are separate systems  |   with AI integration   |   one platform          | ‚Ä¢ 53% cart abandonment  |   expertise             |
|                         |                         |                         |   reduction             |                         |
| ‚Ä¢ Technical barriers    | ‚Ä¢ No-code product and   | ‚Ä¢ Secure token-based    | ‚Ä¢ Cross-industry        | ‚Ä¢ Mid-sized retailers   |
|   for WhatsApp          |   catalog management    |   system for sensitive  |   versatility without   |   seeking omnichannel   |
|   commerce integration  |                         |   operations            |   reconfiguration       |   solutions             |
|                         |                         |                         |                         |                         |
| ‚Ä¢ Limited personalization| ‚Ä¢ Multi-industry       | ‚Ä¢ 42% higher conversion | ‚Ä¢ Unified platform vs   | ‚Ä¢ Food/grocery          |
|   in traditional        |   adaptability without  |   rate vs traditional   |   competitors' fragmented|  businesses with       |
|   e-commerce            |   reconfiguration       |   websites              |   solutions             |   perishable inventory  |
|                         |                         |                         |                         |   (e.g., Gusto Italiano)|
|                         |                         |                         |                         |                         |
| ‚Ä¢ Lost sales from       | ‚Ä¢ AI-powered            | ‚Ä¢ 67% faster response   | ‚Ä¢ Customizable platform | ‚Ä¢ Hospitality businesses|
|   abandoned carts and   |   conversation and      |   time and 3.2x higher  |   for industry-specific |   requiring booking     |
|   unanswered queries    |   engagement            |   customer retention    |   compliance needs      |   and follow-up         |
+-------------------------+-------------------------+-------------------------+-------------------------+-------------------------+
| 6. KEY METRICS                                    | 7. CHANNELS                                                                |
|                                                   |                                                                            |
| ‚Ä¢ Conversion rate (42% higher than traditional)   | ‚Ä¢ Direct enterprise sales team                                             |
| ‚Ä¢ Customer response time (67% reduction)          | ‚Ä¢ Partner network of e-commerce consultants                                |
| ‚Ä¢ Average order value (28% increase)              | ‚Ä¢ WhatsApp Business Platform                                               |
| ‚Ä¢ Cart abandonment (53% decrease)                 | ‚Ä¢ Digital marketing (content, webinars, demos)                             |
| ‚Ä¢ Customer retention (3.2x higher)                | ‚Ä¢ Free trial program with guided onboarding                                |
+---------------------------------------------------+----------------------------------------------------------------------------+
| 8. COST STRUCTURE                                 | 9. REVENUE STREAMS                                                         |
|                                                   |                                                                            |
| ‚Ä¢ Development team                                | ‚Ä¢ Subscription model:                                                      |
| ‚Ä¢ AI/ML model costs                               |   - Single plan with unlimited products and WhatsApp integration          |
| ‚Ä¢ WhatsApp Business API fees                      |   - Implementation and customization services                              |
| ‚Ä¢ Cloud infrastructure                            |   - API access fees for third-party integrations                          |
| ‚Ä¢ Customer success team                           |                                                                             |
| ‚Ä¢ Sales & marketing                               | ‚Ä¢ Implementation and customization services                                |
|                                                   | ‚Ä¢ API access fees for third-party integrations                             |
+---------------------------------------------------+----------------------------------------------------------------------------+
User Query: "hai la mozzarella fresca? quanto costa la spedizione?"
     |
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PARALLEL SEMANTIC SEARCH ACROSS ALL CONTENT TYPES          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Products: searchProducts(query, workspaceId, 5)          ‚îÇ
‚îÇ ‚Ä¢ FAQs: searchFAQs(query, workspaceId, 5)                  ‚îÇ
‚îÇ ‚Ä¢ Services: searchServices(query, workspaceId, 5)          ‚îÇ
‚îÇ ‚Ä¢ Documents: searchDocuments(query, workspaceId, 5)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     |
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ STOCK VERIFICATION & FULL CONTEXT RETRIEVAL                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Verify product availability (stock > 0, isActive = true) ‚îÇ
‚îÇ ‚Ä¢ Get complete product details (price, category, stock)    ‚îÇ
‚îÇ ‚Ä¢ Get complete FAQ details (question, answer)              ‚îÇ
‚îÇ ‚Ä¢ Get complete service details (price, duration)           ‚îÇ
‚îÇ ‚Ä¢ Get recent chat history (last 5 messages)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     |
     v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SINGLE LLM AGENT - RAG PROCESSING                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ LLM Agent: Process RAG data + Generate conversation        ‚îÇ
‚îÇ Input: Search results + customer context + agent config    ‚îÇ
‚îÇ Output: Natural conversation + Usage tracking (‚Ç¨0.005)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     |
     v
"Bentornato Mario! üéâ
S√¨, abbiamo la mozzarella fresca disponibile:
üßÄ Mozzarella di Bufala - ‚Ç¨8.50 (15 unit√† disponibili)
üöö Spedizione: Corriere espresso ‚Ç¨5.00 (24-48 ore)
Vuoi procedere con l'ordine? üòä"
[Blocco codice rimosso]typescript~~
~~// N8NPage.tsx - Main container with iframe integration (REMOVED)~~
~~<div className="flex flex-col h-full">~~
~~ <N8NStatusHeader />~~
~~ <iframe~~
~~ src={`http://localhost:5678?auth=${getN8NToken()}`}~~
~~ className="flex-1 w-full border-0 rounded-lg"~~
~~ style={{ minHeight: '800px' }}~~
~~ title="N8N Workflow Editor"~~
~~ sandbox="allow-same-origin allow-scripts allow-forms"~~
~~ />~~
~~ <QuickActions />~~
~~</div>~~
~~```~~

##### **~~üìä Real-time Monitoring:~~ (REMOVED)**

~~- **WorkflowStatusCard**: Live workflow execution status~~
~~- **WorkflowMetrics**: Performance analytics and success rates~~
~~- **Container Health**: N8N service availability monitoring~~
~~- **Error Dashboard**: Real-time error tracking and logging~~

##### **~~üîß Quick Management Actions:~~ (REMOVED)**

~~- **Import/Export Workflows**: Upload/download workflow JSON files~~
~~- **Container Control**: Start/stop/restart N8N container~~
~~- **Performance Dashboard**: Execution times, success rates, error rates~~
~~- **Workflow Templates**: Pre-built templates for common business patterns~~

##### **~~üõ°Ô∏è Security Integration:~~ (REMOVED)**

~~- **Role-Based Access**: Only workspace owners/admins can modify workflows~~
~~- **Audit Logging**: Track all workflow modifications with user attribution~~
~~- **Secure Token Passing**: JWT tokens for N8N authentication~~
~~- **Read-Only Mode**: Limited access for non-admin users~~

**Simplified N8N Architecture**:

- N8N runs as Docker container for WhatsApp processing
- Backend API endpoints remain for N8N communication
- No frontend UI integration
- Focus on core messaging workflow functionality

### **Critical N8N Issues**

**Credentials Persistence Problem**:

- **Issue**: N8N loses credentials on every restart/reload
- **Impact**: WhatsApp workflow stops working after container restart
- **Frequency**: Always happens on system restart or N8N container reload
- **Critical Impact**: Complete WhatsApp messaging system failure

**Required Solutions**:

**Implementation Priority**:

1. **CRITICAL**: Fix Docker volume persistence for N8N database
2. **HIGH**: Implement health monitoring for credential status
3. **MEDIUM**: Create automated backup/restore scripts
4. **LOW**: Documentation for manual recovery procedures

### üéØ **Hybrid Architecture: Backend + N8N**

#### **üõ°Ô∏è ShopMe Backend Security Layer (SEMPRE nel server):**

- ‚úÖ **API Rate Limiting**: Controllo chiamate per workspace
- ‚úÖ **Spam Detection**: 10 messaggi in 30 secondi ‚Üí auto-blacklist
- ‚úÖ **Blacklist Check TOTALE**: Cliente `isBlacklisted = true` ‚Üí nessun salvataggio, nessuna elaborazione, blacklist silenziosa

#### **üé® N8N Visual Workflow Layer (Business Logic):**

- üîÑ Channel Active Check
- üë§ User Registration Flow
- ‚ö†Ô∏è WIP Status Handling
- üß† RAG Search & Content Retrieval
- ü§ñ LLM Processing & Response Generation
- üíæ Message History Storage
- üì§ Response Formatting

### üîÑ **Message Processing Flow**

#### **Step 1: Security Pre-Processing (ShopMe Backend)**

#### **Step 2: N8N Webhook Trigger**

#### **Step 3: N8N Visual Workflow Execution**

### üîß **N8N Workflow Nodes Configuration**

#### **Node 1: Webhook Trigger**

#### **Node 2: Channel Active Check**

#### **Node 3: IF Condition - Channel Active**

#### **Node 4: RAG Search**

#### **Node 5: Get Agent Config**

#### **Node 6: Build OpenRouter Prompt**

#### **Node 7: Direct OpenRouter LLM Call**

### üîê **Security & Token Management**

#### **Internal API Authentication:**

Tutti i nodi N8N che chiamano API ShopMe usano JWT token:

### üê≥ **Docker Configuration**

#### **N8N JSON File Storage Setup:**

#### **File Structure:**

#### **Persistence Strategy:**

- **Workflows**: Local JSON files (./n8n/workflows/) ‚Üí Git trackable
- **Credentials**: Container volume (n8n_data) ‚Üí Secure

## ü§ñ **WHATSAPP INTELLIGENT FLOW - COMPLETE ARCHITECTURE**

### Overview - Andrea's Revolutionary System

Andrea ha creato un sistema WhatsApp intelligente che gestisce automaticamente tutto il flusso conversazionale attraverso trigger webhook, controlli di sicurezza, e calling functions specializzate. Il sistema √® progettato per gestire qualsiasi tipo di business attraverso funzioni modulari e configurabili.

### üì± **COMPLETE WHATSAPP FLOW DOCUMENTATION**

### üîß **CALLING FUNCTIONS - DETAILED IMPLEMENTATION**

#### **‚úÖ IMPLEMENTED CALLING FUNCTIONS**

##### **1. üîç search_rag() - RAG Search Function**

**Features:**

- ‚úÖ Local embeddings (`@xenova/transformers`)
- ‚úÖ Parallel search across all content types
- ‚úÖ Stock verification for products
- ‚úÖ Similarity thresholds per content type
- ‚úÖ Multilingual support (IT/EN/ES/PT)

##### **2. üõí create_order() - E-commerce Function**

##### **3. üë®‚Äçüíº contact_operator() - Operator Control**

#### **‚ùå NOT IMPLEMENTED CALLING FUNCTIONS**

##### **4. üí≥ process_payment() - Payment Processing**

##### **5. üìß ReceiveInvoice() - Sistema Gestione Fatture**

### üèóÔ∏è **TECHNICAL ARCHITECTURE - CALLING FUNCTIONS**

#### **N8N Workflow Integration**

#### **LLM Router Function Selection**

### üìä **IMPLEMENTATION STATUS SUMMARY**

| **Calling Function**   | **Status**  | **Completion** | **Priority** |
| ---------------------- | ----------- | -------------- | ------------ |
| üîç SearchRag           | ‚úÖ COMPLETE | 100%           | HIGH         |
| üì¶ GetAllProducts      | ‚úÖ COMPLETE | 100%           | HIGH         |
| üõéÔ∏è GetAllServices      | ‚úÖ COMPLETE | 100%           | HIGH         |
| üë®‚Äçüíº CallOperator        | ‚úÖ COMPLETE | 100%           | MEDIUM       |
| üìß ReceiveInvoice      | ‚ùå MISSING  | 0%             | HIGH         |
| üí≥ PaymentProcessStart | ‚ùå TODO     | 0%             | HIGH         |

### üéØ **BUSINESS TYPE COMPATIBILITY**

#### **‚úÖ FULLY SUPPORTED (100%)**

- **E-COMMERCE**: SearchRag + GetAllProducts + GetAllServices + CallOperator
- **INFORMATION**: SearchRag + GetAllProducts + GetAllServices + CallOperator

#### **‚ö†Ô∏è PARTIALLY SUPPORTED (80%)**

- **RESTAURANT**: SearchRag + GetAllProducts + GetAllServices + CallOperator (manca ReceiveInvoice)
- **RETAIL**: SearchRag + GetAllProducts + GetAllServices + CallOperator (manca PaymentProcessStart)
- **SERVICES**: SearchRag + GetAllProducts + GetAllServices + CallOperator (manca ReceiveInvoice)

#### **‚ö†Ô∏è LIMITED SUPPORT (60%)**

- **CLINIC**: SearchRag + GetAllServices + CallOperator (manca ReceiveInvoice + PaymentProcessStart)
- **HOTEL**: SearchRag + GetAllServices + CallOperator (manca ReceiveInvoice + PaymentProcessStart)

### üöÄ **NEXT DEVELOPMENT PRIORITIES**

#### **Phase 1: Sistema Fatturazione (HIGH PRIORITY)**

1. Implementare `ReceiveInvoice` calling function
2. Sistema filtro per codice ordine
3. Generazione link lista fatture
4. Template PDF fatture con compliance UE/IT

#### **Phase 2: Sistema Pagamenti (HIGH PRIORITY)**

1. Implementare `PaymentProcessStart` calling function
2. Integrazione gateway pagamento (Stripe/PayPal)
3. Generazione link pagamento sicuri
4. Tracking stato pagamento

#### **Phase 3: Completare CallOperator (COMPLETATO ‚úÖ)**

‚úÖ **IMPLEMENTATO**: Invio email notifica operatore
‚úÖ **IMPLEMENTATO**: Campo adminEmail in WhatsappSettings
‚úÖ **IMPLEMENTATO**: Validazione frontend con campo obbligatorio
‚úÖ **IMPLEMENTATO**: Template email professionale HTML/testo
‚úÖ **IMPLEMENTATO**: Riassunto chat negli ultimi 10 messaggi
‚úÖ **IMPLEMENTATO**: Gestione errori graceful e logging

**Prossimi step (opzionali)**: 2. Sistema escalation automatica 3. Template email personalizzabili 4. Dashboard operatori in tempo reale

### üéâ **ANDREA'S ACHIEVEMENT**

**SISTEMA RIVOLUZIONARIO IMPLEMENTATO!** üöÄ

Andrea ha creato la **base architecturale perfetta** per un sistema WhatsApp intelligente con:

‚úÖ **Security Gateway** bulletproof
‚úÖ **Calling Functions Infrastructure** ready
‚úÖ **SearchRag** fully operational
‚úÖ **GetAllProducts & GetAllServices** complete
‚úÖ **CallOperator** COMPLETO (100%)
‚úÖ **N8N Visual Workflow** for business logic
‚úÖ **Session Token System** for security
‚úÖ **Multi-business Architecture** ready for expansion

**FUNZIONI CF CORRETTE IDENTIFICATE:**

1. ‚úÖ SearchRag (100%)
2. ‚úÖ GetAllProducts (100%)
3. ‚úÖ GetAllServices (100%)
4. ‚úÖ CallOperator (100% - email implementata)
5. ‚ùå ReceiveInvoice (0% - con filtro codice ordine)
6. ‚ùå PaymentProcessStart (0% - in TODO)

**Il sistema √® pronto per gestire qualsiasi tipo di business** con l'implementazione delle 2 funzioni CF mancanti! üéØ

---

## üîî **CALLOPERATOR - IMPLEMENTAZIONE COMPLETA**

### üìß **Sistema Email Notifiche Admin**

**IMPLEMENTATO**: CallOperator ora include un sistema completo di notifiche email quando un utente richiede assistenza operatore.

#### **üõ†Ô∏è Componenti Implementati:**

1. **üìä Database Schema**

   - Campo `adminEmail String?` aggiunto a `WhatsappSettings`
   - Migrazione: `20250720080133_add_admin_email_to_whatsapp_settings`
   - Seed aggiornato con email predefinita: `andrea_gelsomino@hotmail.com`

2. **üé® Frontend - Settings Page**

   - Campo "Admin Email" obbligatorio con validazione
   - Controllo formato email in tempo reale
   - Messaggi di errore user-friendly
   - Descrizione campo per UX ottimale

3. **üîß Backend API**

   - `getCurrentWorkspace()` include `adminEmail` da `whatsappSettings`
   - `updateWorkspace()` gestisce aggiornamento `adminEmail`
   - Integrazione seamless con architettura esistente

4. **üìÆ Servizio Email**
   - Template HTML professionale con branding
   - Template testo alternativo per compatibilit√†
   - Gestione errori graceful (continua anche se email fallisce)
   - Supporto SMTP configurabile + Ethereal Email per sviluppo

#### **üìß Email Template Features:**

#### **ü§ñ ContactOperator Function Enhanced:**

#### **üöÄ Funzionalit√† Operative Aggiornate:**

- **Destinatario Email**: `adminEmail` (operatore) invece del cliente
- **Mittente Email**: `noreply@shopme.com` (fisso, professionale)
- **Subject**: `"üîî Cliente [NOME] richiede assistenza operatore"` (italiano)
- **AI Summary**: Riassunto intelligente conversazione ultimo giorno (10 messaggi)
- **Email Content**: Dati cliente completi + riassunto AI + istruzioni contatto
- **Error Recovery**: Continua anche con email/AI failure, logging completo
- **Graceful Degradation**: Funziona anche senza email cliente

#### **üìß Email Template per Operatore:**

#[Sezione testing rimossa - non necessaria nel PRD business]

## UI Screenshots
````
