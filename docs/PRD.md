# ShopMe Project - Product Requirements Document (PRD)

## üö® CRITICAL RULE - PRD VERIFICATION MANDATORY

**üö® REGOLA CRITICA**: Questo PRD √® la **FONTE DELLA VERIT√Ä ASSOLUTA** per il progetto ShopMe. Prima di qualsiasi operazione, devo SEMPRE:

1. **Leggere questo PRD** per verificare i requisiti
2. **Verificare i task** nel memory bank (`docs/memory-bank/tasks.md`)
3. **Bloccare l'operazione** se qualcosa non √® chiaro o in dubbio
4. **Chiedere chiarimenti** ad Andrea prima di procedere

**Scala della Verit√†**: PRD ‚Üí Test ‚Üí Codice

## üéØ Project Overview

ShopMe is a comprehensive e-commerce platform with WhatsApp chatbot integration, designed for multi-business operations (ECOMMERCE, RESTAURANT, CLINIC, RETAIL, SERVICES, GENERIC).

## üèóÔ∏è Architecture

### Core Components
- **Backend**: Node.js + TypeScript + Prisma + PostgreSQL
- **Frontend**: React + TypeScript + Vite + TailwindCSS
- **Chatbot**: OpenRouter + AI function calling
- **Database**: PostgreSQL with Prisma ORM
- **Authentication**: JWT tokens with workspace isolation

### Business Focus
- **ECOMMERCE**: Product catalog, cart management, checkout
- **Focus**: Single business type for optimal performance

## ü§ñ Chatbot Architecture

### ‚úÖ UNIFIED DUAL-LLM ARCHITECTURE (Updated December 2024)

**üéØ ARCHITETTURA UNIFICATA - SEMPRE USARE QUESTA STRUTTURA:**

```
USER INPUT (IT/EN/ES/PT) 
‚Üí TranslationService (detect language + translate to EN)
‚Üí DualLLMService (LLM with temperature 0.1 for trigger recognition)
‚Üí SearchRag (if no CF triggered)
‚Üí FormatterService (token replacement + formatting with temperature 0.5)
‚Üí LOCALIZED OUTPUT (IT/EN/ES/PT)
```

### ‚úÖ CORE PRINCIPLES:
- **Single Responsibility**: Each component has ONE clear job
- **Language Flow**: Original Language ‚Üí EN (for LLM) ‚Üí Original Language (for user)
- **Temperature Settings**: LLM 0.0 (deterministic), Formatter 0.0 (deterministic)
- **Token Replacement**: All tokens replaced in FormatterService BEFORE OpenRouter
- **üö® CRITICAL LANGUAGE HANDLING**: FormatterService MUST handle language conversion using applyLanguageFormatting method
- **Zero Hardcoding**: All responses generated by FormatterService LLM

### Function Flow
1. **Translation**: Detect user language, translate to English for LLM processing
2. **LLM Processing**: Temperature 0.1 for deterministic trigger recognition
3. **SearchRag Fallback**: If no CF triggered, use SearchRag for semantic search
4. **Token Replacement**: Replace all tokens with real database data
5. **Formatting**: LLM formats response in user's original language (temperature 0.5)
6. **Output**: Natural, conversational response with proper localization

### Token Management System
```typescript
// UNIFIED TOKEN SYSTEM - Two types of tokens:

// 1. GENERIC TOKENS (FAQ)
{
  question: "How can I place an order?",
  answer: "You can place your order through this secure link. [LINK_WITH_TOKEN]"
}

// 2. SPECIFIC TOKENS (Database Data)
{
  question: "What categories do you have?",
  answer: "We have the following categories: [LIST_CATEGORIES]"
}

// FormatterService replaces ALL tokens BEFORE OpenRouter:
[LINK_WITH_TOKEN] ‚Üí "https://shopme.com/checkout?token=abc123..."
[LIST_CATEGORIES] ‚Üí "- üßÄ *Cheeses & Dairy*\n- üßä *Frozen Products*"
[USER_DISCOUNT] ‚Üí "10%"
```

## üõí Cart Management System

### Web-Based Cart Management
- **Strategy**: All cart operations handled via web interface
- **Link Generation**: Via SearchRag + FAQ with `[LINK_WITH_TOKEN]`
- **Token System**: Universal tokens valid for 1 hour across all pages
- **User Experience**: Direct links to cart management page with full functionality
```

### Supported Operations
- Add products to cart
- Modify quantities
- Remove products
- View total
- Proceed to checkout

### Technical Implementation
- **Frontend-Database Sync**: All cart operations immediately sync with PostgreSQL database
- **API Endpoints**: RESTful endpoints for cart operations (`POST`, `PUT`, `DELETE`)
- **Real-time Updates**: Frontend refreshes cart data from backend after each operation
- **Data Persistence**: All changes persisted in `cart_items` table with automatic totals calculation
- **Token Validation**: All operations validate secure token before database modifications

## üì± WhatsApp Chatbot Integration

### Core Functions
- **Product Search**: `getAllProducts()`, `searchProducts()`
- **Category Browsing**: `getAllCategories()`
- **Document Search**: `searchDocuments()`
- **FAQ Support**: `getFaqInfo()`
- **Order Management**: `confirmOrderFromConversation()`
- **Cart Management**: `generateCartLink()`
- **User Info**: `GetUserInfo()`
- **Order History**: `GetOrdersListLink()`
- **Shipment Tracking**: `GetShipmentTrackingLink()`

### Multi-Language Support
- **Languages**: Italian (IT), English (EN), Spanish (ES), Portuguese (PT)
- **Translation**: OpenRouter-based translation service
- **Product Names**: Never translated (kept in original language)
- **Common Phrases**: Translated for better user experience

### üö® CRITICAL LANGUAGE HANDLING RULES
- **Language Detection**: `detectLanguageFromMessage()` in DualLLMService
- **Response Language**: FormatterService MUST respond in user's original language
- **Language Formatter**: `applyLanguageFormatting()` method handles language conversion
- **Temperature**: 0.0 for deterministic language formatting
- **No Translation Service**: FormatterService handles language directly, no separate translation
- **Critical Rule**: NEVER respond in English when user speaks Italian/Spanish/Portuguese

### Function Calling Strategy
- **Semantic Intelligence**: LLM understands intent without regex patterns
- **Context Awareness**: Maintains conversation history and context
- **Smart Routing**: Automatic function selection based on user intent
- **Error Handling**: Graceful fallbacks and user-friendly error messages

## üîê Security & Authentication

### Token System
- **Universal Tokens**: Single token per customer for all operations
- **Expiration**: 1 hour validity
- **Workspace Isolation**: Automatic filtering by workspaceId
- **Secure Generation**: JWT-based with encrypted payload

### Workspace Isolation
- **Database Level**: All queries filtered by workspaceId
- **API Level**: Automatic workspace validation
- **Frontend Level**: Workspace-specific routing and data

## üìä Data Management

### Product Data
- **Schema**: Products with formato, ProductCode, description, stock, sku
- **Search**: Semantic search with embeddings
- **Categories**: Hierarchical category system
- **Pricing**: Dynamic pricing with workspace-specific rates

### Order Management
- **Order Creation**: From conversation or direct input
- **Status Tracking**: PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
- **Payment Integration**: Multiple payment methods
- **Invoice Generation**: PDF invoices with professional layout

### Customer Management
- **Registration**: Phone-based registration with GDPR compliance
- **Profile Management**: Personal information, preferences, language
- **Order History**: Complete order tracking and history
- **Communication**: WhatsApp integration with conversation history

## üåê Public Access System

### Public Orders
- **Token-Based Access**: Secure links without login
- **Order History**: Complete order list with filtering
- **Order Details**: Individual order information
- **Document Downloads**: Invoice and DDT PDF downloads

### Public Checkout
- **Token-Based Access**: Secure checkout without registration
- **Cart Management**: Full cart functionality
- **Address Management**: Billing and shipping addresses
- **Payment Processing**: Integrated payment system

## üîß Development Guidelines

### Code Standards
- **TypeScript**: Strict typing throughout
- **DDD Architecture**: Domain-driven design patterns
- **Error Handling**: Comprehensive error management
- **Logging**: Structured logging with context
- **Testing**: Unit and integration tests

### Database Standards
- **Prisma ORM**: Type-safe database operations
- **Migrations**: Version-controlled schema changes
- **Seeding**: Automated test data generation
- **Backups**: Regular database backups

### API Standards
- **RESTful Design**: Standard HTTP methods and status codes
- **Swagger Documentation**: Complete API documentation
- **Validation**: Input validation and sanitization
- **Rate Limiting**: API rate limiting and abuse prevention

## üöÄ Deployment

### Environment Setup
- **Development**: Local development with Docker
- **Staging**: Pre-production testing environment
- **Production**: Live environment with monitoring

### Monitoring
- **Health Checks**: System health monitoring
- **Performance**: Response time and throughput monitoring
- **Errors**: Error tracking and alerting
- **Logs**: Centralized logging system

## üìã Testing Strategy

### Test Types
- **Unit Tests**: Individual component testing
- **Integration Tests**: API and database integration
- **E2E Tests**: Complete user journey testing
- **Performance Tests**: Load and stress testing

### Test Data
- **Seeding**: Automated test data generation
- **Mocks**: External service mocking
- **Fixtures**: Reusable test data
- **Cleanup**: Test data cleanup after runs

## üîÑ Maintenance

### Regular Tasks
- **Database Maintenance**: Index optimization, cleanup
- **Security Updates**: Dependency updates, security patches
- **Performance Optimization**: Query optimization, caching
- **Monitoring**: System health and performance monitoring

### Documentation
- **API Documentation**: Swagger/OpenAPI specs
- **Code Documentation**: Inline code comments
- **User Guides**: End-user documentation
- **Developer Guides**: Technical documentation

---

## üìù Version History

- **v1.0**: Initial implementation with basic functionality
- **v2.0**: Multi-business support and enhanced chatbot
- **v3.0**: Web-based cart management and improved UX
- **v4.0**: Current version with streamlined architecture

---

*This PRD is maintained as the single source of truth for the ShopMe project requirements and architecture.*
