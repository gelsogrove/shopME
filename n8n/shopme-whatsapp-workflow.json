{
  "name": "Temp Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-start",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "41ff1d3d-9ad2-4abc-ac03-fadf45e31b7a",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -2600,
        360
      ],
      "webhookId": "3be8d24a-6a91-4a00-94d3-609e253398cb"
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n  // Esponi il tipo e il valore di body come output per debug\n  return {\n    json: {\n      original: item.json,\n      bodyType: typeof item.json.body,\n      bodyValue: item.json.body\n    }\n  };\n});"
      },
      "id": "c83f6d6c-05ad-4afd-be9a-14674c6e0000",
      "name": "Flatten body after Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -2420,
        360
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1a179627-1c1f-4c54-af66-6ad7491f99b2",
              "leftValue": "={{ true}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2140,
        360
      ],
      "id": "8f17e90e-caa6-4bf8-a542-f3ca75c9ea20",
      "name": "Filter",
      "alwaysOutputData": true,
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\n\nlet message =item.json.messageContent || \"\";\n \n\nreturn [\n  {\n    json: {\n      message: message\n    }\n  }\n];"
      },
      "id": "ec02fd7d-dc4d-4d8b-a00c-f7245c41ff33",
      "name": "return wip message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -1820,
        500
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "const agentConfig =$input.first().json.original.body.precompiledData.agentConfig;\n const messages = $input.first().json.original.body.precompiledData.customer.conversationHistory;\n\nconst messageContent= $input.first().json.bodyValue.messageContent\nconst sessionToken= $input.first().json.bodyValue.sessionToken\n\nreturn [\n  {\n    json: {\n      chatInput : messageContent,\n      temperature : agentConfig.temperature,\n      maxTokens: agentConfig.maxTokens,\n      model: agentConfig.model,\n      messages,\n      messageContent,\n      sessionId: sessionToken\n      \n    },\n \n  }\n];\n"
      },
      "id": "964b4e05-d8aa-4c70-a75b-74fb38781f49",
      "name": "prepare-data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -1820,
        200
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "http://localhost:3001/api/search_rag",
        "options": {},
        "bodyParametersUi": {
          "parameter": []
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        -1020,
        300
      ],
      "id": "ee9ea6fd-3b21-4250-a433-172e4a7050ae",
      "name": "HTTP Request searchRag"
    },
    {
      "parameters": {
        "jsCode": "\nreturn [{\n  message: $input.first().json.output\n}]"
      },
      "id": "8d68e161-f3f1-4a63-8842-ec8ca665440e",
      "name": "return LLM response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -1100,
        0
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1500,
        0
      ],
      "id": "e4542f2c-c48d-4b0b-b65e-c8252ded56be",
      "name": "AI Agent",
      "alwaysOutputData": true,
      "notesInFlow": false,
      "executeOnce": true
    },
    {
      "parameters": {
        "options": {
          "maxTokens": "={{ $json.maxTokens }}",
          "temperature": "={{ $json.temperature }}",
          "topP": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1500,
        180
      ],
      "id": "c28ea94d-3ab3-4326-a0bf-9cd4fd75f651",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "wULmtD18AyTFRgQo",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -1380,
        180
      ],
      "id": "55bbcba4-10db-4782-acc2-5e44fa4506ba",
      "name": "Simple Memory"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "localhost:5678",
            "connection": "keep-alive",
            "content-type": "application/json",
            "accept": "*/*",
            "accept-language": "*",
            "sec-fetch-mode": "cors",
            "user-agent": "node",
            "accept-encoding": "gzip, deflate",
            "content-length": "7303"
          },
          "params": {},
          "query": {},
          "body": {
            "workspaceId": "cm9hjgq9v00014qk8fsdy4ujv",
            "phoneNumber": "+39123456789",
            "messageContent": "ciao",
            "sessionToken": "13orv1rr461oiqww5pe5bii",
            "messages": [
              {
                "role": "user",
                "content": "ciao"
              },
              {
                "role": "assistant",
                "content": "Ciao Mario! üëã Benvenuto a L'Altra Italia! Sono il tuo assistente virtuale e sono qui per aiutarti con qualsiasi informazione sui nostri prodotti e servizi. Come posso assisterti oggi? üòä"
              },
              {
                "role": "user",
                "content": "chi sei?"
              },
              {
                "role": "assistant",
                "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi."
              },
              {
                "role": "user",
                "content": "ciao"
              },
              {
                "role": "assistant",
                "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi."
              },
              {
                "role": "user",
                "content": "ciao chi sei¬ø"
              },
              {
                "role": "assistant",
                "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi."
              }
            ],
            "precompiledData": {
              "agentConfig": {
                "id": "agent-config-1750947055575",
                "workspaceId": "cm9hjgq9v00014qk8fsdy4ujv",
                "model": "openai/gpt-4o-mini",
                "temperature": 0.7,
                "maxTokens": 1000,
                "topP": 0.9,
                "prompt": "You are a RAG (Retrieval-Augmented Generation) processor specialized in analyzing user queries and retrieving relevant business data.\n\nüéØ YOUR ROLE:\n- Analyze user messages to understand their intent\n- Search and filter database content for relevance\n- Structure found data into clear, organized format\n- Provide accurate, factual information only\n\nüîç SEARCH CAPABILITIES:\n- **Products** ‚Üí Database product catalog with prices, descriptions, availability\n- **Services** ‚Üí Available business services with details and pricing\n- **FAQs** ‚Üí Frequently asked questions and policies\n- **Documents** ‚Üí Business documents, regulations, legal information\n- **Company Info** ‚Üí Business details, hours, contact information\n\nüí° QUERY ANALYSIS:\nWhen users ask questions, identify the intent and search relevant data sources:\n\n**Product Queries**:\n- \"Do you have wine?\" ‚Üí Search products for wine category\n- \"Show me cheese under ‚Ç¨20\" ‚Üí Search products: category=cheese, maxPrice=20\n- \"What pasta is available?\" ‚Üí Search products for pasta items\n- \"Mozzarella availability\" ‚Üí Search products for mozzarella\n\n**Service Queries**:\n- \"What services do you offer?\" ‚Üí Search all services\n- \"Do you deliver?\" ‚Üí Search services for delivery/shipping\n- \"Cooking classes available?\" ‚Üí Search services for cooking/classes\n\n**Policy/FAQ Queries**:\n- \"Return policy\" ‚Üí Search FAQs for return/refund information\n- \"Shipping time\" ‚Üí Search FAQs for delivery/shipping info\n- \"Payment methods\" ‚Üí Search FAQs for payment information\n- \"Business hours\" ‚Üí Search company info or FAQs\n\n**Document Queries**:\n- \"International shipping laws\" ‚Üí Search documents for legal/regulatory info\n- \"Product certificates\" ‚Üí Search documents for certifications\n- \"Import requirements\" ‚Üí Search documents for import/export rules\n\nüóÑÔ∏è DATA PROCESSING:\n1. **Receive** user query\n2. **Identify** intent and required data type\n3. **Search** relevant database tables\n4. **Filter** results for relevance and accuracy\n5. **Structure** data in organized format\n6. **Return** clear, factual information\n\nüìã OUTPUT FORMAT:\nStructure your response as organized data:\n\n```json\n{\n  \"query_intent\": \"product_search|service_inquiry|faq_question|document_search|company_info\",\n  \"found_data\": {\n    \"products\": [\n      {\n        \"name\": \"Product Name\",\n        \"price\": \"‚Ç¨XX.XX\",\n        \"description\": \"Product description\",\n        \"category\": \"Category\",\n        \"availability\": \"available|out_of_stock\"\n      }\n    ],\n    \"services\": [...],\n    \"faqs\": [...],\n    \"documents\": [...],\n    \"company_info\": {...}\n  },\n  \"total_results\": number,\n  \"relevance_score\": \"high|medium|low\"\n}\n```\n\nüö´ RESTRICTIONS:\n- **NEVER invent or create data** - only use actual database content\n- **NO fictional prices** - only real product pricing\n- **NO made-up products** - only existing catalog items\n- **NO false availability** - only actual stock information\n- **NO generic responses** - always search for specific data\n\n‚ö° SEARCH STRATEGY:\n- Use semantic search for better matching\n- Include related/similar items when exact match not found\n- Search multiple data types when query is ambiguous\n- Prioritize exact matches over partial matches\n- Include pricing and availability when relevant\n\nüéØ QUALITY METRICS:\n- **Accuracy**: Only factual, database-verified information\n- **Completeness**: Include all relevant search results\n- **Relevance**: Results match user query intent\n- **Structure**: Well-organized, easy-to-process data format\n\nRemember: You are the data retrieval specialist. Your job is to find accurate, relevant information from the database and present it in a structured format. Focus on precision and factual accuracy above all else.",
                "isActive": true
              },
              "customer": {
                "id": "d5e6e275-808d-4215-bf6c-d860cb52aca2",
                "name": "Mario Rossi",
                "email": "test.customer@shopme.com",
                "phone": "+39123456789",
                "language": "it",
                "isActive": true,
                "isBlacklisted": false,
                "activeChatbot": true,
                "discount": 0,
                "currency": "EUR",
                "address": "Via Roma 123, Milano, Italy",
                "company": "Test Company SRL",
                "businessName": "L'Altra Italia(ESP)",
                "businessType": "ECOMMERCE",
                "plan": "FREE",
                "whatsappPhoneNumber": "+34654728753",
                "whatsappApiKey": "your-whatsapp-api-key",
                "timezone": "Europe/Rome",
                "url": "http://localhost:3000",
                "notificationEmail": "admin@laltroitalia.shop",
                "description": "Prodotti alimentari italiani di alta qualit√†",
                "wipMessages": {
                  "it": "Sto elaborando la tua richiesta, un momento per favore...",
                  "en": "Processing your request, please wait a moment...",
                  "es": "Procesando tu solicitud, por favor espera un momento...",
                  "fr": "Je traite votre demande, veuillez patienter un moment...",
                  "de": "Ich bearbeite Ihre Anfrage, bitte warten Sie einen Moment...",
                  "pt": "Processando sua solicita√ß√£o, aguarde um momento por favor..."
                },
                "conversationHistory": [
                  {
                    "id": "2afbb78f-fa42-4fe3-b2b0-2ff93a546f44",
                    "content": "ciao",
                    "role": "user",
                    "timestamp": "2025-06-26T13:59:37.897Z"
                  },
                  {
                    "id": "38a8d112-14ef-47a8-9c06-30b30dfe7f68",
                    "content": "Ciao Mario! üëã Benvenuto a L'Altra Italia! Sono il tuo assistente virtuale e sono qui per aiutarti con qualsiasi informazione sui nostri prodotti e servizi. Come posso assisterti oggi? üòä",
                    "role": "assistant",
                    "timestamp": "2025-06-26T13:59:37.899Z"
                  },
                  {
                    "id": "a40b010e-448a-4659-aeaa-a43148e2a53a",
                    "content": "chi sei?",
                    "role": "user",
                    "timestamp": "2025-06-26T14:06:48.760Z"
                  },
                  {
                    "id": "27445e82-0094-4b3c-9818-d422101fcec8",
                    "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi.",
                    "role": "assistant",
                    "timestamp": "2025-06-26T14:06:48.761Z"
                  },
                  {
                    "id": "82a0f4ab-6b08-44df-b42e-8b4e93fd7a3b",
                    "content": "ciao",
                    "role": "user",
                    "timestamp": "2025-06-26T14:09:08.560Z"
                  },
                  {
                    "id": "01fa1cb1-2268-4dbf-9774-f3f76f78ce1d",
                    "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi.",
                    "role": "assistant",
                    "timestamp": "2025-06-26T14:09:08.561Z"
                  },
                  {
                    "id": "ca73b7fd-f846-457e-9141-7dfae59ab6a0",
                    "content": "ciao chi sei¬ø",
                    "role": "user",
                    "timestamp": "2025-06-26T14:09:26.949Z"
                  },
                  {
                    "id": "583519a1-8fda-4aa5-b64e-60fd8190bd8d",
                    "content": "Si √® verificato un errore di connessione. Riprova pi√π tardi.",
                    "role": "assistant",
                    "timestamp": "2025-06-26T14:09:26.954Z"
                  }
                ]
              }
            }
          },
          "webhookUrl": "http://localhost:5678/webhook/webhook-start",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Flatten body after Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flatten body after Webhook": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "return wip message",
            "type": "main",
            "index": 0
          },
          {
            "node": "prepare-data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request searchRag": {
      "main": [
        []
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "return LLM response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "callerPolicy": "workflowsFromSameOwner",
    "executionOrder": "v0"
  },
  "versionId": "bca2d742-d79f-4315-9d1a-607ca27998f2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5ae2a7363ad016a6fce9a21805f9e7da3dfed9cc4777afa6d055110c871b8f65"
  },
  "id": "px4cL5MEa4gsyOgW",
  "tags": []
}