{
  "name": "ShopMe WhatsApp Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-start",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "43717cb6-168b-43eb-9a83-93d2efeda016",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -1560,
        180
      ],
      "webhookId": "3be8d24a-6a91-4a00-94d3-609e253398cb"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -620,
        80
      ],
      "id": "33927e63-93c0-4af3-81f6-65f0f4ce1cde",
      "name": "Wait3",
      "webhookId": "59956c9f-d486-4e0c-b949-a3c634750e9b"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.precompiledData.businessInfo.isActive }}",
              "operation": "=equal",
              "value2": "={{ false }}"
            }
          ]
        },
        "combineOperation": "any"
      },
      "id": "6620d60b-d1ef-4b78-8256-3cd88e2ebb0c",
      "name": "IsChannelActive?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -840,
        180
      ],
      "alwaysOutputData": false,
      "executeOnce": true,
      "retryOnFail": false,
      "notesInFlow": true
    },
    {
      "parameters": {
        "jsCode": "const message = \"SI CI SIAOM ...\"\n\nreturn [\n  {\n    json: {\n      message\n    }\n  }\n];"
      },
      "id": "0a70987e-8e38-4415-8bdd-70616e637e9c",
      "name": "return",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -400,
        80
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\n// Corretto percorso dei dati\nconst userLang = item.precompiledData.customer.language || 'it';\nconst wipMessages = item.precompiledData.wipMessages || {};\n\n// Fallback se la lingua non esiste\nconst message = wipMessages[userLang]\n\nreturn [\n  {\n    json: {\n      message \n    }\n  }\n];\n"
      },
      "id": "68eba54b-27c3-4815-a70b-900b7c4e1d34",
      "name": "return wip message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -620,
        280
      ],
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.precompiledData.customer.activeChatbot }}",
              "value2": "=true"
            }
          ]
        }
      },
      "id": "7450105b-9479-4d82-9d30-c2478d0d43eb",
      "name": "is activeChatbot?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1060,
        280
      ],
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "notesInFlow": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.precompiledData.customer.isBlacklisted }}",
              "value2": true
            }
          ]
        }
      },
      "id": "9de5cd81-9251-427b-8bd5-1943200ab07e",
      "name": "IsUserBlocked?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1280,
        180
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "retryOnFail": true,
      "notesInFlow": true
    },
    {
      "parameters": {
        "jsCode": "const message = \"User blocked\"\n\nreturn [\n  {\n    json: {\n      message\n    }\n  }\n];"
      },
      "id": "0e89f620-5ad7-404b-9b18-1a93568624c0",
      "name": "return userblock",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -1060,
        80
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\nconst activeChatbot = item.precompiledData.customer.activeChatbot;\nconst message = activeChatbot ? \"Chatbot is active\" : \"Chatbot is not active\";\n\nreturn [\n  {\n    json: {\n      message: item.precompiledData\n    }\n  }\n];\n"
      },
      "id": "cdf79464-eb11-4774-bb66-a46725e76cf7",
      "name": "return activechallenge",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -840,
        380
      ],
      "alwaysOutputData": true
    }
  ],
  "pinData": {},
  "connections": {
    "LLM Router (Intent Classification)": {
      "main": [
        [
          {
            "node": "Needs RAG Search?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Formatter (Response Generation)": {
      "main": [
        [
          {
            "node": "Save Inbound Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send WhatsApp Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "IsUserBlocked?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IsChannelActive?": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "return wip message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "return",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is activeChatbot?": {
      "main": [
        [
          {
            "node": "IsChannelActive?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "return activechallenge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "return wip message": {
      "main": [
        []
      ]
    },
    "IsUserBlocked?": {
      "main": [
        [
          {
            "node": "return userblock",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "is activeChatbot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "90ec9b8e-af4e-4255-af30-9b6ba825c1c8",
  "meta": {
    "instanceId": "5ae2a7363ad016a6fce9a21805f9e7da3dfed9cc4777afa6d055110c871b8f65",
    "templateCredsSetupCompleted": true
  },
  "id": "1XPQF919PP0MEdtH",
  "tags": []
}